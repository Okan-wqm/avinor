# =============================================================================
# Flight Training Management System - Docker Compose
# Production-ready microservices infrastructure
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # INFRASTRUCTURE SERVICES
  # ===========================================================================

  # PostgreSQL Primary Database
  postgres-primary:
    image: postgres:16-alpine
    container_name: ftms-postgres-primary
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres_secure_password}
      POSTGRES_DB: postgres
    volumes:
      - postgres_primary_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/init-databases.sql:/docker-entrypoint-initdb.d/init.sql
      - ./infrastructure/postgres/postgresql.conf:/etc/postgresql/postgresql.conf
    ports:
      - "5432:5432"
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ftms-network
    restart: unless-stopped

  # PgBouncer Connection Pooler
  pgbouncer:
    image: edoburu/pgbouncer:1.21.0
    container_name: ftms-pgbouncer
    environment:
      DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD:-postgres_secure_password}@postgres-primary:5432/postgres
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 25
    ports:
      - "6432:6432"
    depends_on:
      postgres-primary:
        condition: service_healthy
    networks:
      - ftms-network
    restart: unless-stopped

  # Redis Cluster Nodes
  redis-node-1:
    image: redis:7-alpine
    container_name: ftms-redis-1
    command: redis-server --port 7000 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7000:7000"
    volumes:
      - redis_data_1:/data
    networks:
      - ftms-network
    restart: unless-stopped

  redis-node-2:
    image: redis:7-alpine
    container_name: ftms-redis-2
    command: redis-server --port 7001 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7001:7001"
    volumes:
      - redis_data_2:/data
    networks:
      - ftms-network
    restart: unless-stopped

  redis-node-3:
    image: redis:7-alpine
    container_name: ftms-redis-3
    command: redis-server --port 7002 --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes
    ports:
      - "7002:7002"
    volumes:
      - redis_data_3:/data
    networks:
      - ftms-network
    restart: unless-stopped

  # Redis Standalone (for development simplicity)
  redis:
    image: redis:7-alpine
    container_name: ftms-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ftms-network
    restart: unless-stopped

  # NATS Message Broker with JetStream
  nats:
    image: nats:2.10-alpine
    container_name: ftms-nats
    command:
      - "--name=ftms-nats"
      - "--jetstream"
      - "--store_dir=/data"
      - "--http_port=8222"
      - "--port=4222"
      - "--user=${NATS_USER:-admin}"
      - "--pass=${NATS_PASSWORD:-nats_password}"
      - "--max_payload=1MB"
      - "--max_connections=1000"
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # HTTP monitoring
      - "6222:6222"   # Cluster routing (for future clustering)
    volumes:
      - nats_data:/data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ftms-network
    restart: unless-stopped

  # NATS Box (CLI tools for debugging - development only)
  nats-box:
    image: natsio/nats-box:latest
    container_name: ftms-nats-box
    profiles:
      - dev
    environment:
      - NATS_URL=nats://admin:nats_password@nats:4222
    networks:
      - ftms-network
    command: ["tail", "-f", "/dev/null"]
    depends_on:
      nats:
        condition: service_healthy

  # MinIO Object Storage
  minio:
    image: minio/minio:latest
    container_name: ftms-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - ftms-network
    restart: unless-stopped

  # ===========================================================================
  # MONITORING SERVICES
  # ===========================================================================

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: ftms-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infrastructure/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - ftms-network
    restart: unless-stopped

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: ftms-grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: false
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/monitoring/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    networks:
      - ftms-network
    restart: unless-stopped

  # Jaeger Tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: ftms-jaeger
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: 9411
    ports:
      - "5775:5775/udp"
      - "6831:6831/udp"
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"
      - "14250:14250"
      - "14268:14268"
      - "14269:14269"
      - "9411:9411"
    networks:
      - ftms-network
    restart: unless-stopped

  # ===========================================================================
  # MICROSERVICES
  # ===========================================================================

  # User Service
  user-service:
    build:
      context: .
      dockerfile: services/user-service/docker/Dockerfile
    container_name: ftms-user-service
    environment:
      - DJANGO_ENV=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DB_HOST=postgres-primary
      - DB_PORT=5432
      - DB_NAME=user_db
      - DB_USER=user_service
      - DB_PASSWORD=${USER_SERVICE_DB_PASSWORD:-user_service_password_change_me}
      - REDIS_URL=redis://redis:6379/0
      - NATS_SERVERS=nats://nats:4222
      - NATS_USER=${NATS_USER:-admin}
      - NATS_PASSWORD=${NATS_PASSWORD:-nats_password}
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - SERVICE_NAME=user-service
      - SERVICE_PORT=8001
    ports:
      - "8001:8001"
    depends_on:
      postgres-primary:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    volumes:
      - ./services/user-service/src:/app
      - ./shared:/app/shared
    networks:
      - ftms-network
    restart: unless-stopped

  # Organization Service
  organization-service:
    build:
      context: .
      dockerfile: services/organization-service/docker/Dockerfile
    container_name: ftms-organization-service
    environment:
      - DJANGO_ENV=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DB_HOST=postgres-primary
      - DB_NAME=org_db
      - DB_USER=org_service
      - DB_PASSWORD=${ORG_SERVICE_DB_PASSWORD:-org_service_password_change_me}
      - REDIS_URL=redis://redis:6379/0
      - NATS_SERVERS=nats://nats:4222
      - NATS_USER=${NATS_USER:-admin}
      - NATS_PASSWORD=${NATS_PASSWORD:-nats_password}
      - SERVICE_NAME=organization-service
      - SERVICE_PORT=8002
    ports:
      - "8002:8002"
    depends_on:
      postgres-primary:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - ftms-network
    restart: unless-stopped

  # Aircraft Service
  aircraft-service:
    build:
      context: .
      dockerfile: services/aircraft-service/docker/Dockerfile
    container_name: ftms-aircraft-service
    environment:
      - DJANGO_ENV=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DB_HOST=postgres-primary
      - DB_NAME=aircraft_db
      - DB_USER=aircraft_service
      - DB_PASSWORD=${AIRCRAFT_SERVICE_DB_PASSWORD:-aircraft_service_password_change_me}
      - REDIS_URL=redis://redis:6379/0
      - NATS_SERVERS=nats://nats:4222
      - NATS_USER=${NATS_USER:-admin}
      - NATS_PASSWORD=${NATS_PASSWORD:-nats_password}
      - SERVICE_NAME=aircraft-service
      - SERVICE_PORT=8003
    ports:
      - "8003:8003"
    depends_on:
      postgres-primary:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - ftms-network
    restart: unless-stopped

  # Booking Service
  booking-service:
    build:
      context: .
      dockerfile: services/booking-service/docker/Dockerfile
    container_name: ftms-booking-service
    environment:
      - DJANGO_ENV=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DB_HOST=postgres-primary
      - DB_NAME=booking_db
      - DB_USER=booking_service
      - DB_PASSWORD=${BOOKING_SERVICE_DB_PASSWORD:-booking_service_password_change_me}
      - REDIS_URL=redis://redis:6379/0
      - NATS_SERVERS=nats://nats:4222
      - NATS_USER=${NATS_USER:-admin}
      - NATS_PASSWORD=${NATS_PASSWORD:-nats_password}
      - SERVICE_NAME=booking-service
      - SERVICE_PORT=8005
    ports:
      - "8005:8005"
    depends_on:
      postgres-primary:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - ftms-network
    restart: unless-stopped

  # Flight Service
  flight-service:
    build:
      context: .
      dockerfile: services/flight-service/docker/Dockerfile
    container_name: ftms-flight-service
    environment:
      - DJANGO_ENV=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DB_HOST=postgres-primary
      - DB_NAME=flight_db
      - DB_USER=flight_service
      - DB_PASSWORD=${FLIGHT_SERVICE_DB_PASSWORD:-flight_service_password_change_me}
      - REDIS_URL=redis://redis:6379/0
      - NATS_SERVERS=nats://nats:4222
      - NATS_USER=${NATS_USER:-admin}
      - NATS_PASSWORD=${NATS_PASSWORD:-nats_password}
      - SERVICE_NAME=flight-service
      - SERVICE_PORT=8006
    ports:
      - "8006:8006"
    depends_on:
      postgres-primary:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - ftms-network
    restart: unless-stopped

  # Training Service
  training-service:
    build:
      context: .
      dockerfile: services/training-service/docker/Dockerfile
    container_name: ftms-training-service
    environment:
      - DJANGO_ENV=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DB_HOST=postgres-primary
      - DB_NAME=training_db
      - DB_USER=training_service
      - DB_PASSWORD=${TRAINING_SERVICE_DB_PASSWORD:-training_service_password_change_me}
      - REDIS_URL=redis://redis:6379/0
      - NATS_SERVERS=nats://nats:4222
      - NATS_USER=${NATS_USER:-admin}
      - NATS_PASSWORD=${NATS_PASSWORD:-nats_password}
      - SERVICE_NAME=training-service
      - SERVICE_PORT=8007
    ports:
      - "8007:8007"
    depends_on:
      postgres-primary:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - ftms-network
    restart: unless-stopped

  # Notification Service
  notification-service:
    build:
      context: .
      dockerfile: services/notification-service/docker/Dockerfile
    container_name: ftms-notification-service
    environment:
      - DJANGO_ENV=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DB_HOST=postgres-primary
      - DB_NAME=notif_db
      - DB_USER=notif_service
      - DB_PASSWORD=${NOTIF_SERVICE_DB_PASSWORD:-notif_service_password_change_me}
      - REDIS_URL=redis://redis:6379/0
      - NATS_SERVERS=nats://nats:4222
      - NATS_USER=${NATS_USER:-admin}
      - NATS_PASSWORD=${NATS_PASSWORD:-nats_password}
      - SERVICE_NAME=notification-service
      - SERVICE_PORT=8013
    ports:
      - "8013:8013"
    depends_on:
      postgres-primary:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - ftms-network
    restart: unless-stopped

  # ===========================================================================
  # API GATEWAY - KONG
  # ===========================================================================

  # Kong Database (PostgreSQL)
  kong-database:
    image: postgres:16-alpine
    container_name: ftms-kong-database
    environment:
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: ${KONG_PG_PASSWORD:-kong_password_change_me}
      POSTGRES_DB: kong
    volumes:
      - kong_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ftms-network
    restart: unless-stopped

  # Kong Migrations (runs once)
  kong-migration:
    image: kong:3.5
    container_name: ftms-kong-migration
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PORT: 5432
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: ${KONG_PG_PASSWORD:-kong_password_change_me}
      KONG_PG_DATABASE: kong
    depends_on:
      kong-database:
        condition: service_healthy
    networks:
      - ftms-network
    restart: on-failure

  # Kong API Gateway
  kong:
    build:
      context: ./services/api-gateway
      dockerfile: docker/Dockerfile
    container_name: ftms-kong
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PORT: 5432
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: ${KONG_PG_PASSWORD:-kong_password_change_me}
      KONG_PG_DATABASE: kong
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 ssl
      KONG_ADMIN_LISTEN: 0.0.0.0:8001, 0.0.0.0:8444 ssl
      KONG_PLUGINS: bundled,flightschool-auth
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_LOG_LEVEL: info
      # Redis for rate limiting
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # JWT Settings
      JWT_PUBLIC_KEY_PATH: /etc/kong/jwt/public.pem
      JWT_ALGORITHM: RS256
      JWT_ISSUER: flightschool-auth
    ports:
      - "80:8000"      # HTTP Proxy
      - "443:8443"     # HTTPS Proxy
      - "8444:8444"    # Admin API HTTPS
    volumes:
      - ./services/api-gateway/kong:/etc/kong/declarative
      - ./services/api-gateway/kong/jwt-keys:/etc/kong/jwt:ro
    depends_on:
      kong-database:
        condition: service_healthy
      kong-migration:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ftms-network
    restart: unless-stopped

  # Konga Admin UI (Development only)
  konga:
    image: pantsel/konga:latest
    container_name: ftms-konga
    profiles:
      - dev
    environment:
      NODE_ENV: development
      TOKEN_SECRET: ${KONGA_TOKEN_SECRET:-konga_secret_change_me}
      DB_ADAPTER: postgres
      DB_HOST: kong-database
      DB_PORT: 5432
      DB_USER: kong
      DB_PASSWORD: ${KONG_PG_PASSWORD:-kong_password_change_me}
      DB_DATABASE: konga
    ports:
      - "1337:1337"
    depends_on:
      kong-database:
        condition: service_healthy
    networks:
      - ftms-network
    restart: unless-stopped

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  ftms-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  postgres_primary_data:
  redis_data:
  redis_data_1:
  redis_data_2:
  redis_data_3:
  nats_data:
  minio_data:
  prometheus_data:
  grafana_data:
  kong_data:
