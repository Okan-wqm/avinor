; =============================================================================
; PgBouncer Configuration
; Connection pooling for PostgreSQL
; =============================================================================

[databases]
; Service databases - Primary (read/write)
user_db = host=postgres-primary port=5432 dbname=user_db
org_db = host=postgres-primary port=5432 dbname=org_db
aircraft_db = host=postgres-primary port=5432 dbname=aircraft_db
maintenance_db = host=postgres-primary port=5432 dbname=maintenance_db
booking_db = host=postgres-primary port=5432 dbname=booking_db
flight_db = host=postgres-primary port=5432 dbname=flight_db
training_db = host=postgres-primary port=5432 dbname=training_db
theory_db = host=postgres-primary port=5432 dbname=theory_db
cert_db = host=postgres-primary port=5432 dbname=cert_db
finance_db = host=postgres-primary port=5432 dbname=finance_db
doc_db = host=postgres-primary port=5432 dbname=doc_db
report_db = host=postgres-primary port=5432 dbname=report_db
notif_db = host=postgres-primary port=5432 dbname=notif_db

; Read replicas (for read-heavy operations)
user_db_ro = host=postgres-replica port=5432 dbname=user_db
org_db_ro = host=postgres-replica port=5432 dbname=org_db
aircraft_db_ro = host=postgres-replica port=5432 dbname=aircraft_db
booking_db_ro = host=postgres-replica port=5432 dbname=booking_db
flight_db_ro = host=postgres-replica port=5432 dbname=flight_db
training_db_ro = host=postgres-replica port=5432 dbname=training_db
report_db_ro = host=postgres-replica port=5432 dbname=report_db

[pgbouncer]
; Connection settings
listen_addr = 0.0.0.0
listen_port = 6432
unix_socket_dir = /var/run/pgbouncer

; Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

; TLS settings (optional)
; server_tls_sslmode = require
; client_tls_sslmode = allow

; Pool mode: transaction is recommended for most use cases
pool_mode = transaction

; Pool sizing
max_client_conn = 1000
default_pool_size = 25
min_pool_size = 5
reserve_pool_size = 5
reserve_pool_timeout = 3

; Connection limits per user/database
max_db_connections = 100
max_user_connections = 100

; Timeouts
server_connect_timeout = 3
server_idle_timeout = 600
server_lifetime = 3600
client_idle_timeout = 300
client_login_timeout = 60
query_timeout = 120
query_wait_timeout = 120

; Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
stats_period = 60
verbose = 0

; Admin console
admin_users = pgbouncer_admin
stats_users = pgbouncer_stats

; Connection reset
server_reset_query = DISCARD ALL
server_reset_query_always = 0

; DNS settings
dns_max_ttl = 15
dns_zone_check_period = 0

; Low-level tuning
pkt_buf = 4096
listen_backlog = 128
sbuf_loopcnt = 5

; Application name tracking
application_name_add_host = 1
